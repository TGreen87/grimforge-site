# Session Notes — 2025‑09‑14

Purpose: Unblock admin “Save” and seed a test product for QA checkout on the dev Branch Deploy. Capture durable steps so any new chat can pick up instantly.

## Current State
- Branch Deploy: https://dev--obsidianriterecords.netlify.app
- Seeded product: `/products/test-vinyl-dark-rituals`
  - Variant: SKU `SHADOWMOON-DARK-RITUALS-STD`, price 45.99
  - Inventory: on_hand 10, allocated 0, available 10
- DB tables present: `products`, `variants` (bootstrapped), `inventory` (bootstrapped)
- RLS policies on `products` include a public read for active rows: `products_select_active` (active = true)
- RLS on `variants` and `inventory`: enabled with permissive preview policies (public SELECT; authenticated write)

## What We Did
1) Seeded admin role + product safely (no unique constraints assumed):
   - Added “No‑DO Seed” (sequential SQL) to avoid dollar‑quote issues in Studio.
   - Set `format = 'vinyl'` to satisfy `products_format_check`.
2) Schema detection returned no variants/product_variants/inventory.
   - Bootstrapped minimal `variants` and `inventory` with FK types matched to `products.id` (uuid or text).
3) Added/verified products read policy for public active rows (prevents 500 on product page).
4) Updated the local Puppeteer smoke to open the seeded slug and drive shipping selection.

## How To Resume QA
1) Public checks (dev URL): home, `#vinyl`, robots/sitemap.
2) Product: open `/products/test-vinyl-dark-rituals`, verify “Add to Cart”; screenshot `product.png`.
3) Checkout modal:
   - AU address; press “Refresh rates”; select first option; screenshot `checkout-shipping.png`.
   - Continue → Place order; verify `checkout.stripe.com`; screenshot `stripe.png`.
4) Admin visuals (optional): `admin-products.png`, `admin-variants.png`, `admin-inventory.png`.

## Local Scripts
- Smoke runner: `npm run test:puppeteer`
  - Screenshots output: `docs/qa-screenshots/`
  - Env for branch URL: `BASE_URL=https://dev--obsidianriterecords.netlify.app`

## Troubleshooting Quick Map
- 500 on product page → ensure `products_select_active` policy exists and `active = true` for the product.
- “slug missing” → run the slug DDL block in `SUPABASE-SEED.md`.
- “variants not found” → run Bootstrap block; then re‑seed.
- “format check failed” → your check accepts lowercase; use `format = 'vinyl'`.
- Dollar‑quote errors in Studio → use the “No‑DO Seed” section (no DO blocks).

## Next Actions
- Run smoke against dev; capture `product.png`, `checkout-shipping.png`, `stripe.png`.
- If shipping returns static Stripe options: confirm labels/prices.
- If you prefer Browser MCP, run the prompts in `docs/MCP-PUPPETEER.md` (added product‑slug step).

---

## Update — 2025‑09‑15

What changed today (dev):
- Verified Supabase via MCP: product `test-vinyl-dark-rituals` (active) exists; variant SKU `SHADOWMOON-DARK-RITUALS-STD` exists; inventory available=10; RLS `products_select_active` present; public SELECT on variants/inventory present.
- Product page hardening: normalized `inventory` join and wrapped `/products/[slug]` metadata/page in try/catch to avoid 500s from unexpected shapes; returns 404 on unexpected errors.
- JSON‑LD currency set to AUD.
- Supabase server client updated to fall back to `SUPABASE_URL/ANON_KEY/SERVICE_ROLE` envs in addition to `NEXT_PUBLIC_*` at runtime.

Current status:
- Dev branch deploy: `/` OK, robots/sitemap OK. `/products/test-vinyl-dark-rituals` still returns 500 (likely runtime/env, not DB/RLS).
- `/api/checkout` returns 500 "Failed to create order" on branch deploy — likely missing `STRIPE_SECRET_KEY` at runtime for the function, or service role not mapped. Data is present, so this is env/runtime.

Pending actions (Netlify envs for dev branch):
- Required: `STRIPE_SECRET_KEY`; ensure one of `SUPABASE_SERVICE_ROLE_KEY` or `SUPABASE_SERVICE_ROLE` is present (it is, per screenshot); `NEXT_PUBLIC_SITE_URL` set to the branch URL; optional `SITE_URL_STAGING` set to the same URL.
- Optional: `AUSPOST_API_KEY` + `AUSPOST_ORIGIN_POSTCODE` for live quotes (fallback to Stripe static works without).

After envs updated:
1) Redeploy dev branch.
2) Re‑run smoke:
   - Product slug loads and shows “Add to Cart” (no 500).
   - Checkout modal → “Refresh rates” shows Stripe static options (labels/prices recorded).
   - Continue → Place order redirects to `checkout.stripe.com`.
   - Save screenshots to `docs/qa-screenshots/` with timestamps and return pass/fail summary.
