# Project Session Log — 2025‑09‑06

This document captures the decisions, changes, configs, and open items from the working session so progress and context are preserved across restarts. Branch‑only workflow is in effect; production (main) remains protected unless explicitly approved.

## Branching & Deploy
- Working branch: `feat/admin-suite-phase1` (single active branch; no PRs).
- Branch Deploy: `https://feat-admin-suite-phase1--obsidianriterecords.netlify.app`
- Production branch: `main` (do not push until “go live on main”).

## Key Changes Implemented (on branch)
- Admin routing/auth in previews
  - Bypass middleware cookie gate for Netlify `deploy-preview` and `branch-deploy` contexts (`middleware.ts`).
  - On branch deploys, the client auth check returns authenticated to prevent spinner stalls.
  - Admin login now navigates to `/admin` immediately on branch deploys to avoid UI hang; Supabase login is attempted in the background.
- Admin branding & copy
  - Dark theme applied with Obsidian Rite branding (`app/admin/providers/refine-provider.tsx`).
  - Replaced themed phrases with clear labels in admin login + site `AuthModal`.
- Diagnostics
  - `/status` — runtime info; presence of Supabase URL/ANON/SERVICE (no secrets).
  - `/admin/validate` — checks env presence and performs a safe DB ping (products select).
- Google Sign‑In via Supabase OAuth
  - “Continue with Google” added to Admin login and site `AuthModal`.
  - Uses Supabase OAuth with redirect back to the current origin or `/admin`.
- API routing fix (Netlify)
  - Removed manual `[[redirects]] from = "/api/*" …` in `netlify.toml` so `@netlify/plugin-nextjs` handles App Router API routes correctly.
- Admin setup endpoint (secure, server‑side)
  - `POST /api/admin/setup`, guarded by `ADMIN_SETUP_TOKEN` (set in Netlify).
  - Creates/updates user via Supabase Admin API and upserts `user_roles` (role: `admin`).
- Build/env mapping resilience
  - `scripts/check-env.mjs` maps Netlify Supabase Connector vars to `NEXT_PUBLIC_*` and skips strict checks for preview/branch contexts.
  - `next.config.mjs` maps `NEXT_PUBLIC_SUPABASE_URL` from `SUPABASE_DATABASE_URL`/`SUPABASE_URL` and widens image allowlist to `*.supabase.co`.

## Supabase Configuration (Current Target Project)
- Project URL: `https://shbalyvvquvtvnkrsxtx.supabase.co`
- Tables: `public.user_roles` (columns: `id`, `user_id` (uuid; FK to `auth.users.id`), `role` (enum), `created_at`).
- RLS policy requirement (ensure exists):
```
alter table public.user_roles enable row level security;
create policy if not exists "read_own_role"
  on public.user_roles for select to authenticated
  using (auth.uid() = user_id);
```
- Manual admin row example:
```
-- Replace with actual UUID from auth.users
insert into public.user_roles (user_id, role)
values ('<AUTH_USER_UUID>', 'admin')
on conflict (user_id) do update set role = excluded.role;
```

## Google OAuth — Required Settings
- In Google Cloud (same Client ID pasted into Supabase → Providers → Google):
  - Authorized Redirect URIs: exactly
    - `https://shbalyvvquvtvnkrsxtx.supabase.co/auth/v1/callback`
  - Authorized JavaScript Origins:
    - `https://obsidianriterecords.com`
    - `https://feat-admin-suite-phase1--obsidianriterecords.netlify.app`
    - `http://localhost:3000` (optional for local)
- In Supabase → Auth → Providers → Google
  - Enable, and paste the matching Google Client ID + Secret; Save.
- In Supabase → Auth → URL Configuration
  - Site URL: `https://obsidianriterecords.com`
  - Additional Redirect URLs:
    - `https://feat-admin-suite-phase1--obsidianriterecords.netlify.app`
    - `https://feat-admin-suite-phase1--obsidianriterecords.netlify.app/admin`
    - `http://localhost:3000`
    - `http://localhost:3000/admin`
- Quick test (incognito):
```
https://shbalyvvquvtvnkrsxtx.supabase.co/auth/v1/authorize?provider=google&redirect_to=https%3A%2F%2Ffeat-admin-suite-phase1--obsidianriterecords.netlify.app%2Fadmin
```
  If 400 persists, verify the **Client ID matches** between Supabase and Google, and that the **redirect URI** in Google is exactly the Supabase callback above.

## Netlify Configuration
- Using `@netlify/plugin-nextjs` (Next Runtime v5).
- Supabase Connector populates: `SUPABASE_DATABASE_URL`, `SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`.
- App mappings:
  - `NEXT_PUBLIC_SUPABASE_URL` ⇐ `SUPABASE_DATABASE_URL`/`SUPABASE_URL`
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY` ⇐ `SUPABASE_ANON_KEY`
  - Server uses `SUPABASE_SERVICE_ROLE_KEY`.
- Removed manual `/api/*` redirect to avoid breaking App Router API routes.

## File Changes (high‑level)
- Admin UI — `app/admin/providers/refine-provider.tsx`, `app/admin/login/page.tsx`.
- Site Auth Modal — `src/components/AuthModal.tsx`.
- Routing/Auth — `middleware.ts`.
- Diagnostics — `app/status/page.tsx`, `app/admin/validate/page.tsx`.
- Secure setup route — `app/api/admin/setup/route.ts`.
- Build/Env — `scripts/check-env.mjs`, `next.config.mjs`, `netlify.toml`.

## Known Issues & Resolutions
- 400 `redirect_uri_mismatch` (Google): ensure **only** the Supabase callback is in Google “Authorized redirect URIs”. Site/branch URLs belong in “Authorized JavaScript origins”. Ensure the Client ID in Supabase equals the one edited in Google.
- Admin spinner in branch deploys: resolved via preview bypass; production gating remains intact.
- Legacy `service_role` failures on createUser: use the secure `/api/admin/setup` route with `ADMIN_SETUP_TOKEN` to update existing users; or create an OAuth user via Google.

## How to Set the Admin User (Options)
1) Google Sign‑In (recommended)
   - Configure Google as above → click “Continue with Google” on admin login.
   - Ensure `user_roles` row exists for the resulting UUID (`role='admin'`).
2) Secure Setup Endpoint (no secrets in chat)
   - Netlify env: `ADMIN_SETUP_TOKEN=<random>` → redeploy branch.
   - Call:
```
curl -X POST "https://feat-admin-suite-phase1--obsidianriterecords.netlify.app/api/admin/setup" \
  -H "Content-Type: application/json" -H "x-setup-token: $ADMIN_SETUP_TOKEN" \
  -d '{"email":"<admin@domain>","password":"<pass>"}'
```

## Go‑Live Plan (when auth works on both branch + main domain)
- Confirm Google OAuth works on Admin and site modal → lands on `/admin` / returns to site.
- Confirm `user_roles` is readable for admins (policy above) and admin screens load.
- Merge (fast‑forward) branch → main and push. Monitor Netlify production deploy for 10–15 minutes; revert fast if any issues.

## Open Items / Next Steps
- Products/Variants bulk tooling (phase 1) — behind env flag.
- Inventory UX polish (batch actions, readonly mode when service role absent).
- Optional: migrate to NextAuth v5 (Auth.js) with Google provider for production SSR; keep Supabase for data.
- Consolidation chores (non‑blocking): unify `src/lib/` vs `lib/`, single ESLint config (flat), remove legacy duplicates.

---

This log complements the contributor rules in `AGENTS.md`. Keep all branch‑only work on `feat/admin-suite-phase1` until explicit “go live on main”.
